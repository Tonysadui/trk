<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#667eea" />
<title>Смена пароля — Attendance</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }

    .container {
      width: 100%;
      max-width: 400px;
    }

    .box {
      background: #fff;
      padding: 32px 22px 24px 22px;
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(30,41,59,0.07);
    }

    .logo-section {
      text-align: center;
      margin-bottom: 28px;
    }

    .logo {
      width: 60px;
      height: 60px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: #f1f5f9;
      box-shadow: 0 2px 8px #2563eb11;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    h2 {
      color: #18181b;
      font-size: 24px;
      margin: 0 0 8px 0;
      font-weight: 700;
    }

    .subtitle {
      color: #64748b;
      font-size: 13px;
      margin-bottom: 22px;
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      color: #18181b;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
      color: #18181b;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.22s cubic-bezier(.4,0,.2,1), box-shadow 0.22s cubic-bezier(.4,0,.2,1);
    }

    input:focus {
      outline: none;
      border-color: #2563eb;
      background: #fff;
      box-shadow: 0 0 0 2px #2563eb22;
    }

    input::placeholder {
      color: #94a3b8;
    }

    button {
      width: 100%;
      padding: 12px 14px;
      margin-top: 18px;
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.22s cubic-bezier(.4,0,.2,1), box-shadow 0.22s cubic-bezier(.4,0,.2,1);
      box-shadow: 0 2px 8px #2563eb11;
      position: relative;
      outline: none;
    }
    button:hover, button:focus {
      background: #1d4ed8;
      box-shadow: 0 4px 16px #2563eb22;
    }
    button:active {
      background: #2563eb;
      box-shadow: 0 1px 4px #2563eb22;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .muted {
      color: #64748b;
      font-size: 12px;
      margin-top: 14px;
      text-align: center;
      line-height: 1.5;
    }

    .error {
      color: #ef4444;
      margin-top: 10px;
      padding: 10px 12px;
      background: #fef2f2;
      border-left: 3px solid #ef4444;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }
    .error:not(:empty) {
      display: block;
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      .box {
        padding: 18px 6px 14px 6px;
      }
      h2 {
        font-size: 20px;
      }
      .logo {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }
      input, button {
        font-size: 15px;
        padding: 10px 10px;
      }
      label {
        font-size: 12px;
      }
      .muted {
        font-size: 11px;
      }
    }
    .box {
      padding: 20px 16px;
    }

    h2 {
      font-size: 20px;
    }

    .logo {
      width: 48px;
      height: 48px;
      font-size: 22px;
    }
  }

  @media (hover: none) and (pointer: coarse) {
    input {
      font-size: 16px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="box">
      <div class="logo-section">
        <div class="logo"><img src="logo-trk.png" alt="Логотип ТРК" /></div>
        <h2>Смена пароля</h2>
        <p class="subtitle">Обновите пароль администратора</p>
      </div>
      <div class="form-group">
        <label for="newpw">Новый пароль</label>
        <input id="newpw" type="password" placeholder="Минимум 4 символа" />
      </div>
      <div class="form-group">
        <label for="conf">Подтвердите пароль</label>
        <input id="conf" type="password" placeholder="Повторите пароль" />
      </div>
      <button id="changeBtn" onclick="change()">Сменить пароль</button>
      <button class="btn-back" onclick="history.back()">← Назад</button>
      <div id="msg"></div>
    </div>
  </div>
    <div class="container">
      <div class="box">
        <div class="logo-section">
          <div class="logo"><img src="logo-trk.png" alt="Логотип ТРК" /></div>
          <h2>Attendance</h2>
          <p class="subtitle">Система управления посещаемостью</p>
        </div>
        <form id="changeForm">
          <div class="form-group">
            <label for="oldPassword">Старый пароль</label>
            <input id="oldPassword" class="input" type="password" placeholder="••••••••" />
          </div>
          <div class="form-group">
            <label for="newPassword">Новый пароль</label>
            <input id="newPassword" class="input" type="password" placeholder="••••••••" />
          </div>
          <button id="changeBtn" class="btn" type="submit">Сменить пароль</button>
          <div id="error" class="error"></div>
        </form>
        <div class="muted">Если возникли проблемы — обратитесь к администратору</div>
      </div>
    </div>
  <script>
async function change(){
  const np = document.getElementById('newpw').value;
  const c = document.getElementById('conf').value;
  const msg = document.getElementById('msg');
  const btn = document.getElementById('changeBtn');
  msg.textContent = '';
  msg.className = '';
  
  if(!np || np.length < 4) { 
    msg.textContent = 'Пароль должен содержать минимум 4 символа'; 
    msg.className = 'error';
    return; 
  }
  if(np !== c) { 
    msg.textContent = 'Пароли не совпадают'; 
    msg.className = 'error';
    return; 
  }

  btn.disabled = true;
  btn.textContent = 'Подождите...';
  
  try{
    const token = localStorage.getItem('token');
    const res = await fetch('/api/changePassword', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        'Authorization': 'Bearer ' + token 
      },
      body: JSON.stringify({ newPassword: np })
    });
    const j = await res.json();
    if(j.ok){ 
      msg.textContent = '✓ Пароль успешно изменён. Перенаправляю на вход...'; 
      msg.className = 'success';
      localStorage.removeItem('token'); 
      setTimeout(() => location.href = '/login.html', 1500); 
    } else {
      msg.textContent = j.error || 'Ошибка при смене пароля'; 
      msg.className = 'error';
      btn.disabled = false;
      btn.textContent = 'Сменить пароль';
    }
  } catch(e) { 
    msg.textContent = 'Ошибка сети'; 
    msg.className = 'error';
    btn.disabled = false;
    btn.textContent = 'Сменить пароль';
  }
}
document.getElementById('conf').addEventListener('keypress', (e) => { 
  if(e.key === 'Enter' && !document.getElementById('changeBtn').disabled) change(); 
});
</script>
</body></html>
